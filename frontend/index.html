<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>ShopEase - Your One-Stop Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-bag-heart-fill me-2"></i>ShopEase
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="search-bar mx-auto position-relative">
                    <form class="d-flex" onsubmit="handleSearch(event)">
                        <input class="form-control" type="search" placeholder="Search for products, brands and more" id="search-input" autocomplete="off">
                        <button class="btn btn-warning" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                    <div id="search-dropdown" class="search-dropdown" style="display: none;">
                    </div>
                </div>

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="auth-buttons">
                        <a class="nav-link" href="/login.html">
                            <i class="bi bi-person me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item dropdown" id="user-menu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="user-name">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile.html"><i class="bi bi-person me-2"></i>My Profile</a></li>
                            <li><a class="dropdown-item" href="/profile.html#orders"><i class="bi bi-box me-2"></i>Orders</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Utils.handleLogout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="/cart.html">
                            <i class="bi bi-cart3 me-1"></i>Cart
                            <span class="badge bg-warning cart-badge" id="cart-badge" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Category Bar -->
    <div class="category-bar">
        <div class="container">
            <div class="d-flex overflow-auto" id="category-list">
                <!-- Categories loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container py-4">
        <!-- Hero Banner -->
        <div class="card bg-primary text-white mb-4">
            <div class="card-body text-center py-5">
                <h1 class="display-5 fw-bold">Welcome to ShopEase</h1>
                <p class="lead mb-4">Discover amazing products at unbeatable prices</p>
                <a href="#products" class="btn btn-warning btn-lg">Shop Now</a>
            </div>
        </div>

        <!-- Featured Products -->
        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-star-fill text-warning me-2"></i>Featured Products</h4>
                <a href="#" class="text-decoration-none" onclick="showAllProducts()">View All <i class="bi bi-arrow-right"></i></a>
            </div>
            <div class="row" id="featured-products">
                <!-- Products loaded dynamically -->
            </div>
        </section>

        <!-- All Products -->
        <section id="products">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0" id="products-title">All Products</h4>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="sort-select" onchange="handleSort()">
                        <option value="">Sort By</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                        <option value="name">Name</option>
                    </select>
                </div>
            </div>
            <div class="row" id="product-list">
                <!-- Products loaded dynamically -->
            </div>

            <!-- Load More -->
            <div class="text-center mt-4" id="load-more-container" style="display: none;">
                <button class="btn btn-outline-primary" onclick="loadMoreProducts()">
                    Load More Products
                </button>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-3 col-6 mb-4">
                    <h6>ABOUT</h6>
                    <a href="#">Contact Us</a>
                    <a href="#">About Us</a>
                    <a href="#">Careers</a>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <h6>HELP</h6>
                    <a href="#">Payments</a>
                    <a href="#">Shipping</a>
                    <a href="#">Returns</a>
                    <a href="#">FAQ</a>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <h6>POLICY</h6>
                    <a href="#">Return Policy</a>
                    <a href="#">Terms of Use</a>
                    <a href="#">Privacy</a>
                </div>
                <div class="col-md-3 col-6 mb-4">
                    <h6>SOCIAL</h6>
                    <a href="#"><i class="bi bi-facebook me-2"></i>Facebook</a>
                    <a href="#"><i class="bi bi-twitter me-2"></i>Twitter</a>
                    <a href="#"><i class="bi bi-instagram me-2"></i>Instagram</a>
                </div>
            </div>
            <hr class="border-secondary">
            <p class="text-center mb-0">&copy; 2024 ShopEase. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        let currentPage = 1;
        let currentCategory = null;
        let currentSearch = null;
        let hasMore = false;
        let searchTimeout = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            Utils.updateNavbar();
            initSearchDropdown();

            // Load all data in parallel for faster page load
            await Promise.all([
                loadCategories(),
                loadFeaturedProducts(),
                loadProducts()
            ]);
        });

        // Initialize search dropdown
        function initSearchDropdown() {
            const searchInput = document.getElementById('search-input');
            const dropdown = document.getElementById('search-dropdown');

            // Handle input for live search
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }

                // Debounce search
                searchTimeout = setTimeout(() => {
                    showSearchSuggestions(query);
                }, 300);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-bar')) {
                    dropdown.style.display = 'none';
                }
            });

            // Handle keyboard navigation
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Highlight matching text
        function highlightMatch(text, query) {
            if (!query) return text;
            const idx = text.toLowerCase().indexOf(query.toLowerCase());
            if (idx === -1) return text;
            return text.slice(0, idx) + '<strong>' + text.slice(idx, idx + query.length) + '</strong>' + text.slice(idx + query.length);
        }

        // Show search suggestions - Google/Flipkart style
        async function showSearchSuggestions(query) {
            const dropdown = document.getElementById('search-dropdown');

            try {
                const response = await API.Products.getProducts({ search: query, perPage: 8 });
                const products = response.products;

                if (products.length === 0) {
                    dropdown.innerHTML = '<div class="search-dropdown-header">No products found</div>';
                    dropdown.style.display = 'block';
                    return;
                }

                const suggestions = products.slice(0, 6);
                let html = '<div class="search-dropdown-header">Suggestions</div>';

                suggestions.forEach(p => {
                    html += `
                        <a href="/product.html?id=${p.id}" class="search-suggestion">
                            <i class="bi bi-search"></i>
                            <span class="suggestion-text">${highlightMatch(p.name, query)}</span>
                            <span class="suggestion-category">in ${p.category}</span>
                            <i class="bi bi-arrow-up-left arrow-icon"></i>
                        </a>
                    `;
                });

                dropdown.innerHTML = html;
                dropdown.style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
                dropdown.style.display = 'none';
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const categories = await API.Products.getCategories();
                const container = document.getElementById('category-list');

                container.innerHTML = `
                    <a href="#" onclick="filterByCategory(null)" class="text-nowrap ${!currentCategory ? 'text-primary fw-bold' : ''}">All</a>
                    ${categories.map(cat => `
                        <a href="#" onclick="filterByCategory('${cat.name}')" class="text-nowrap ${currentCategory === cat.name ? 'text-primary fw-bold' : ''}">
                            ${cat.name} (${cat.product_count})
                        </a>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load featured products
        async function loadFeaturedProducts() {
            const container = document.getElementById('featured-products');
            container.innerHTML = Utils.createSkeletonCards(4);

            try {
                const products = await API.Products.getFeatured(4);
                if (products.length === 0) {
                    container.innerHTML = '<p class="text-muted">No featured products available.</p>';
                    return;
                }
                container.innerHTML = products.map(p => Utils.createProductCard(p)).join('');
            } catch (error) {
                container.innerHTML = '<p class="text-danger">Error loading featured products.</p>';
            }
        }

        // Load products
        async function loadProducts(append = false) {
            const container = document.getElementById('product-list');
            const loadMoreContainer = document.getElementById('load-more-container');

            if (!append) {
                container.innerHTML = Utils.createSkeletonCards(8);
                currentPage = 1;
            }

            try {
                const response = await API.Products.getProducts({
                    page: currentPage,
                    perPage: 12,
                    category: currentCategory,
                    search: currentSearch,
                });

                hasMore = response.has_more;
                loadMoreContainer.style.display = hasMore ? 'block' : 'none';

                const html = response.products.map(p => Utils.createProductCard(p)).join('');

                if (append) {
                    container.insertAdjacentHTML('beforeend', html);
                } else {
                    container.innerHTML = html || '<p class="text-muted col-12">No products found.</p>';
                }

                // Update title
                const title = document.getElementById('products-title');
                if (currentSearch) {
                    title.textContent = `Search results for "${currentSearch}"`;
                } else if (currentCategory) {
                    title.textContent = currentCategory;
                } else {
                    title.textContent = 'All Products';
                }
            } catch (error) {
                container.innerHTML = '<p class="text-danger col-12">Error loading products. Please try again.</p>';
            }
        }

        // Load more products
        function loadMoreProducts() {
            currentPage++;
            loadProducts(true);
        }

        // Filter by category
        function filterByCategory(category) {
            event.preventDefault();
            currentCategory = category;
            currentSearch = null;
            document.getElementById('search-input').value = '';
            loadCategories();
            loadProducts();
        }

        // Handle search - redirect to search results page
        function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value.trim();
            if (query) {
                // Hide dropdown and redirect to search page
                document.getElementById('search-dropdown').style.display = 'none';
                window.location.href = '/search.html?q=' + encodeURIComponent(query);
            }
        }

        // Handle sort
        function handleSort() {
            const sort = document.getElementById('sort-select').value;
            // Client-side sort for simplicity
            const container = document.getElementById('product-list');
            const cards = Array.from(container.children);

            if (sort === 'price_low') {
                cards.sort((a, b) => {
                    const priceA = parseFloat(a.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
                    const priceB = parseFloat(b.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
                    return priceA - priceB;
                });
            } else if (sort === 'price_high') {
                cards.sort((a, b) => {
                    const priceA = parseFloat(a.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
                    const priceB = parseFloat(b.querySelector('.product-price').textContent.replace(/[^\d]/g, ''));
                    return priceB - priceA;
                });
            } else if (sort === 'name') {
                cards.sort((a, b) => {
                    const nameA = a.querySelector('.product-title').textContent;
                    const nameB = b.querySelector('.product-title').textContent;
                    return nameA.localeCompare(nameB);
                });
            }

            cards.forEach(card => container.appendChild(card));
        }

        // Show all products
        function showAllProducts() {
            event.preventDefault();
            currentCategory = null;
            currentSearch = null;
            document.getElementById('search-input').value = '';
            loadCategories();
            loadProducts();
            document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
